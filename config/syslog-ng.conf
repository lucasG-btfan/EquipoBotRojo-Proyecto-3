#############################################################################
# Default syslog-ng.conf file which collects all local logs into a
# single file called /var/log/messages tailored to container usage.
#
# The changes from the stock, default syslog-ng.conf file is that we've
# dropped the system() source that is not needed and that we enabled network
# connections using default-network-drivers(). Customize as needed and
# override using the -v option to docker, such as:
#
#  docker run ...  -v "$PWD/syslog-ng.conf":/etc/syslog-ng/syslog-ng.conf
#

# /etc/syslog-ng/syslog-ng.conf

# /etc/syslog-ng/syslog-ng.conf
@version: 3.35

# Opciones globales
options {
    chain_hostnames(off);
    flush_lines(0);
    use_dns(no);
    use_fqdn(no);
    owner("root");
    group("adm");
    perm(0640);
    stats_freq(0);
    bad_hostname("^gconfd$");
    time_reopen(10);
};

# Fuentes de logs
source s_local {
    system();
    internal();
};

source s_network {
    tcp(ip(0.0.0.0) port(514) max-connections(100));
    udp(ip(0.0.0.0) port(514));
};

# Filtros por tipo de servicio
filter f_auth { facility(auth, authpriv); };
filter f_syslog { facility(syslog); };
filter f_cron { facility(cron); };
filter f_daemon { facility(daemon); };
filter f_kern { facility(kern); };
filter f_mail { facility(mail); };
filter f_user { facility(user); };

# Filtros por severidad
filter f_emerg { level(emerg); };
filter f_alert { level(alert); };
filter f_crit { level(crit); };
filter f_err { level(err); };
filter f_warn { level(warn); };

# Filtros personalizados para detección
filter f_ssh_failed {
    facility(auth, authpriv) and
    match("Failed password" value("MESSAGE"));
};

filter f_sudo_usage {
    facility(auth, authpriv) and
    match("sudo" value("PROGRAM"));
};

filter f_iptables_drop {
    facility(kern) and
    match("iptables.*DROP" value("MESSAGE"));
};
#Reglas nuevas de deteccion incorporadas en el ejercicio 2:
#login como root
filter f_root_login_attempt {
  match("Failed password for root" value("MESSAGE")); 
};
#escaneo de puertos
filter f_port_scan {
    match("DPT=" value("MESSAGE"));
};
#Servicio reiniciado repetidamente (errores,ataques, entre otros)
filter f_service_restart {
    match("Started" value("MESSAGE"));
};
#Acceso denegado
filter f_access_denied {
    match ("Access denied" value("MESSAGE"));
};
#Error del kernel
filter f_kernel_oops {
   match("Oops" value("MESSAGE"));
};


# Destinos de logs
destination d_auth { file("/var/log/auth.log"); };
destination d_syslog { file("/var/log/syslog"); };
destination d_cron { file("/var/log/cron.log"); };
destination d_daemon { file("/var/log/daemon.log"); };
destination d_kern { file("/var/log/kern.log"); };

# Destino centralizado para análisis
destination d_centralized {
    file("/var/log/centralized/all.log"
        template("[${ISODATE}] ${HOST} ${PROGRAM}[${PID}]: ${MESSAGE}\n")
        create_dirs(yes)
    );
};

# Destino para eventos de seguridad
destination d_security_alerts {
    file("/var/log/security/alerts.log"
        template("[${ISODATE}] ${HOST} [ALERT] ${PROGRAM}: ${MESSAGE}\n")
        create_dirs(yes)
    );
};

destination d_failed_ssh {
    file("/var/log/security/failed_ssh.log"
        template("[${ISODATE}] ${HOST} ${MESSAGE}\n")
        create_dirs(yes)
    );
};
#Destination para las reglas de deteccion del ejercicio 2
destination d_root_login {
     file("/var/log/security/root_login_attempts.log"
        template("[${ISODATE}] ${HOST} ${MESSAGE}\n")
        create_dirs(yes)
    );
};
destination d_port_scan {
  file("/var/log/security/port_scan.log"
        template("[${ISODATE}] ${HOST} ${MESSAGE}\n")
        create_dirs(yes)
    );
};
destination d_service_restart {
    file("/var/log/security/service_restart.log"
        template("[${ISODATE}] ${HOST} ${MESSAGE}\n")
        create_dirs(yes)
    ); 
};
destination d_access_denied {
  file("/var/log/security/access_denied.log"
        template("[${ISODATE}] ${HOST} ${MESSAGE}\n")
        create_dirs(yes)
    );
};
destination d_kernel_oops {
    file("/var/log/security/kernel_oops.log"
        template("[${ISODATE}] ${HOST} ${MESSAGE}\n")
        create_dirs(yes)
    );
};

# Conexiones (source -> filter -> destination)
log { source(s_local); filter(f_auth); destination(d_auth); };
log { source(s_local); filter(f_syslog); destination(d_syslog); };
log { source(s_local); filter(f_cron); destination(d_cron); };
log { source(s_local); filter(f_daemon); destination(d_daemon); };
log { source(s_local); filter(f_kern); destination(d_kern); };

# Logs de red
log { source(s_network); destination(d_centralized); };

# Logs de seguridad
log { source(s_local); source(s_network); filter(f_ssh_failed); destination(d_failed_ssh); };
log { source(s_local); source(s_network); filter(f_sudo_usage); destination(d_security_alerts); };
log { source(s_local); source(s_network); filter(f_iptables_drop); destination(d_security_alerts); };

# Logs criticos
log { source(s_local); source(s_network); filter(f_emerg); destination(d_security_alerts); };
log { source(s_local); source(s_network); filter(f_alert); destination(d_security_alerts); };
log { source(s_local); source(s_network); filter(f_crit); destination(d_security_alerts); };

#Logs para reglas de deteccion personalizadas del ejercicio 2
log { source(s_local); source(s_network); filter(f_root_login_attempt); destination(d_root_login); };
log { source(s_local); source(s_network); filter(f_port_scan); destination(d_port_scan); };
log { source(s_local); source(s_network); filter(f_service_restart); destination(d_service_restart); };
log { source(s_local); source(s_network); filter(f_access_denied); destination(d_access_denied); };
log { source(s_local); source(s_network); filter(f_kernel_oops); destination(d_kernel_oops); };

#Logs para reglas de deteccion (para que entren en el archivo general donde estan todos los logs)
log { source(s_local); source(s_network); filter(f_root_login_attempt); destination(d_security_alerts); };
log { source(s_local); source(s_network); filter(f_port_scan); destination(d_security_alerts); };
log { source(s_local); source(s_network); filter(f_service_restart); destination(d_security_alerts); };
log { source(s_local); source(s_network); filter(f_access_denied); destination(d_security_alerts); };
log { source(s_local); source(s_network); filter(f_kernel_oops); destination(d_security_alerts); };