input {
  http {
    port => 8080
    codec => "json"
  }

  file {
    path => "/var/log/centralized/json/*/*.log"
    start_position => "beginning"
    codec => "json"
    type => "syslog"
    sincedb_path => "/dev/null"
  }
}

filter {
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # GeoIP enrichment bÃ¡sico
  if [source_ip] {
    geoip {
      source => "source_ip"
      target => "geoip"
    }
  }

  if ![severity] {
    mutate {
      add_field => { "severity" => "medium" }
    }
  }

  if ![category] {
    mutate {
      add_field => { "category" => "unknown" }
    }
  }

  if ![rule_name] {
    mutate {
      add_field => { "rule_name" => "default-rule" }
    }
  }

  # threat_score basado en severity
  if [severity] == "critical" {
    mutate { add_field => { "threat_score" => 100 } }
  } else if [severity] == "high" {
    mutate { add_field => { "threat_score" => 75 } }
  } else if [severity] == "medium" {
    mutate { add_field => { "threat_score" => 50 } }
  } else if [severity] == "low" {
    mutate { add_field => { "threat_score" => 25 } }
  } else {
    mutate { add_field => { "threat_score" => 10 } }
  }

  # REMOVER CAMPOS PROBLEMÃTICOS
  mutate {
    remove_field => ["headers", "host", "@version", "url", "user_agent", "http"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "security-logs-%{+YYYY.MM.dd}"
  }

  stdout {
    codec => rubydebug
  }
}
