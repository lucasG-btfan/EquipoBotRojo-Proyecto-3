input {
  http {
    port => 8080
    codec => json
  }
}

filter {
  date {
    match => [ "timestamp", "ISO8601" ]
    target => "@timestamp"
  }
  
  if [source_ip] {
    geoip {
      source => "source_ip"
      target => "geoip"
      database => "/usr/share/geoip/GeoLite2-City.mmdb"
    }
    
    if [geoip][country_name] {
      mutate {
        add_field => { "country" => "%{[geoip][country_name]}" }
        add_field => { "country_code" => "%{[geoip][country_code2]}" }
      }
    }
  }
  
  if [source_ip] {
    translate {
      field => "source_ip"
      destination => "ip_reputation"
      dictionary => {
        "185.220.101.4" => "malicious"
        "45.155.205.233" => "malicious"
        "94.102.61.24" => "malicious"
        "192.168.1.100" => "internal_test"
        "10.0.0.0/8" => "private"
        "172.16.0.0/12" => "private"
        "192.168.0.0/16" => "private"
      }
      fallback => "unknown"
    }
    
    if [ip_reputation] == "malicious" {
      mutate {
        add_field => { "threat_intel_flag" => "malicious_ip" }
        replace => { "threat_score" => "%{[threat_score].to_i + 30}" }
      }
    }
  }
  
  if [category] {
    translate {
      field => "category"
      destination => "threat_category"
      dictionary => {
        "malware" => "T1204: User Execution"
        "ransomware" => "T1486: Data Encrypted for Impact"
        "phishing" => "T1566: Phishing"
        "bruteforce" => "T1110: Brute Force"
        "dos" => "T1499: Endpoint Denial of Service"
        "scanning" => "T1595: Active Scanning"
        "intrusion" => "T1190: Exploit Public-Facing Application"
      }
      fallback => "Tactic: Unknown"
    }
  }
  
  if [severity] == "critical" {
    mutate { add_field => { "threat_score" => 100 } }
  } else if [severity] == "high" {
    mutate { add_field => { "threat_score" => 75 } }
  } else if [severity] == "medium" {
    mutate { add_field => { "threat_score" => 50 } }
  } else if [severity] == "low" {
    mutate { add_field => { "threat_score" => 25 } }
  } else {
    mutate { add_field => { "threat_score" => 10 } }
  }
  
  if [event_count] and [event_count].to_i > 5 {
    mutate {
      replace => { "threat_score" => "%{[threat_score].to_i + 15}" }
      add_field => { "threat_intel_flag" => "high_event_count" }
    }
  }
  
  if [rule_name] =~ /(?i)(brute|force|password|credential)/ {
    mutate {
      add_field => { "attack_pattern" => "Credential Access" }
      add_field => { "mitre_technique" => "T1110" }
    }
  }
  if [rule_name] =~ /(?i)(ransom|encrypt|crypto)/ {
    mutate {
      add_field => { "attack_pattern" => "Impact" }
      add_field => { "mitre_technique" => "T1486" }
    }
  }
  
  if [source] == "n8n" {
    mutate {
      add_field => { "data_source" => "n8n_workflow" }
    }
  }
  
  ruby {
    code => '
      score = event.get("threat_score").to_i
      score = 100 if score > 100
      score = 0 if score < 0
      event.set("threat_score_final", score)
      
      # Clasificar riesgo
      if score >= 80
        event.set("risk_level", "critical")
      elsif score >= 60
        event.set("risk_level", "high")
      elsif score >= 40
        event.set("risk_level", "medium")
      elsif score >= 20
        event.set("risk_level", "low")
      else
        event.set("risk_level", "informational")
      end
    '
  }
}

output {
  if [data_source] == "n8n_workflow" {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "n8n-alerts-%{+YYYY.MM.dd}"
    }
  } 
  
  else {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "security-logs-%{+YYYY.MM.dd}"
    }
  }
  
  stdout {
    codec => rubydebug
  }
}